<script>
        // Investment return expectations by risk level
        const investmentReturns = {
            conservative: { min: 0.04, avg: 0.05, max: 0.06 },
            moderate: { min: 0.06, avg: 0.08, max: 0.10 },
            aggressive: { min: 0.08, avg: 0.10, max: 0.12 }
        };
        
        // NC-specific data
        const ncData = {
            socialSecurityAvg: 1850, // Monthly for NC/VA retirees
            pensionPlans: {
                'nc-teacher': { monthly: 2800, age: 65 },
                'nc-state': { monthly: 2400, age: 65 },
                'federal': { monthly: 3200, age: 65 },
                'none': { monthly: 0, age: 65 }
            },
            costOfLiving: 0.95, // NC slightly below national average
            stateTaxBenefits: {
                '401k': true, 'ira': true, 'pension': true
            }
        };

        // --- GLOBAL VARIABLES ---
        let selectedAccount = 'mixed';
        let calculationResults = {};

        // --- HELPER FUNCTIONS ---
        function updateFutureIncomePreview() {
            const currentAge = parseFloat(document.getElementById('currentAge').value) || 0;
            const retirementAge = parseFloat(document.getElementById('retirementAge').value) || 0;
            const incomeToday = parseFloat(document.getElementById('retirementIncome').value) || 0;
            
            const inflationRate = 0.03; // Matches the label text
            const yearsToRetirement = Math.max(0, retirementAge - currentAge);
            
            // Calculate Future Value: PV * (1+r)^n
            const futureIncome = incomeToday * Math.pow(1 + inflationRate, yearsToRetirement);
            
            document.getElementById('futureIncomePreview').value = Math.round(futureIncome).toLocaleString();
        }

        function updateExpectedReturn() {
            const riskLevel = document.getElementById('riskLevel').value;
            const returnData = investmentReturns[riskLevel];
            document.getElementById('expectedReturn').value = (returnData.avg * 100).toFixed(1);
        }
        
        function selectAccount(accountType) {
            document.querySelectorAll('.account-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`[data-account="${accountType}"]`).classList.add('active');
            document.getElementById('accountType').value = accountType;
            
            if (accountType === 'mixed') {
                updateExpectedReturn(); 
            } else {
                const accountReturns = { '401k': 8.0, 'ira': 7.5, 'brokerage': 9.0 };
                document.getElementById('expectedReturn').value = accountReturns[accountType] || 8.0;
            }
        }

        // --- MAIN CALCULATION ---
        function calculateRetirement() {
            // Get form data (with defaults to prevent NaN)
            const currentAge = parseInt(document.getElementById('currentAge').value) || 35;
            const retirementAge = parseInt(document.getElementById('retirementAge').value) || 65;
            const lifeExpectancy = parseInt(document.getElementById('lifeExpectancy').value) || 90;
            const currentSavings = parseFloat(document.getElementById('currentSavings').value) || 0;
            const monthlyIncome = parseFloat(document.getElementById('monthlyIncome').value) || 0;
            const monthlyContributions = parseFloat(document.getElementById('monthlyContributions').value) || 0;
            const retirementIncome = parseFloat(document.getElementById('retirementIncome').value) || 0;
            const inflationRate = 0.03; // Fixed at 3% per the hidden input logic
            const socialSecurity = parseFloat(document.getElementById('socialSecurity').value) || ncData.socialSecurityAvg;
            const pension = parseFloat(document.getElementById('pension').value) || 0;
            const expenseMultiplier = parseFloat(document.getElementById('expenseMultiplier').value) || 0.8;
            const expectedReturn = parseFloat(document.getElementById('expectedReturn').value) / 100 || 0.08;
            
            // Calculate key numbers
            const yearsToRetirement = Math.max(0, retirementAge - currentAge);
            const monthsToRetirement = yearsToRetirement * 12;
            
            // 1. Calculate Retirement Needs (Inflation Adjusted)
            const monthlyExpensesAtRetirement = monthlyIncome * expenseMultiplier * Math.pow(1 + inflationRate, yearsToRetirement);
            
            // 2. Calculate Social Security & Pension in Future Dollars
            const socialSecurityAtRetirement = socialSecurity * Math.pow(1 + inflationRate, yearsToRetirement);
            const pensionAtRetirement = pension * Math.pow(1 + inflationRate, yearsToRetirement);
            const totalSocialIncome = socialSecurityAtRetirement + pensionAtRetirement;
            
            // 3. Calculate the NET Monthly Gap
            const monthlyIncomeGap = Math.max(0, monthlyExpensesAtRetirement - totalSocialIncome);
            const annualIncomeGap = monthlyIncomeGap * 12;
            
            // 4. Calculate Portfolio Goal (The "Nest Egg" needed) - Using 4% Rule
            // If annual gap is 0, goal is 0.
            const fundGap = annualIncomeGap > 0 ? (annualIncomeGap / 0.04) : 0; 
            
            // 5. Calculate Projected Savings
            const futureValueCurrent = currentSavings * Math.pow(1 + expectedReturn, yearsToRetirement);
            const monthlyRate = expectedReturn / 12;
            let futureValueContributions = 0;
            
            if (monthlyRate > 0 && monthsToRetirement > 0) {
                futureValueContributions = monthlyContributions * ((Math.pow(1 + monthlyRate, monthsToRetirement) - 1) / monthlyRate);
            } else {
                futureValueContributions = monthlyContributions * monthsToRetirement;
            }
            
            const totalProjectedSavings = futureValueCurrent + futureValueContributions;
            
            // 6. Calculate Shortage/Surplus
            const retirementGap = fundGap - totalProjectedSavings; 
            
            // 7. Calculate Fix (Additional Monthly Contribution)
            let additionalMonthlyNeeded = 0;
            if (retirementGap > 0 && monthsToRetirement > 0 && monthlyRate > 0) {
                additionalMonthlyNeeded = retirementGap / ((Math.pow(1 + monthlyRate, monthsToRetirement) - 1) / monthlyRate);
            }
            
            // SAVE RESULTS GLOBALLY (This fixes the NaN issue in other functions)
            calculationResults = {
                currentAge, retirementAge, yearsToRetirement,
                currentSavings, monthlyContributions, expectedReturn,
                totalRetirementFundNeeded: fundGap, 
                totalProjectedSavings,
                retirementGap,
                additionalMonthlyNeeded,
                monthlyExpensesAtRetirement
            };
            
            // Display Everything
            displayResults(calculationResults);
            displayStrategyComparison(); // This relies on calculationResults being set above
            displayTimeline();
            
            // Show sections
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('strategyComparison').style.display = 'block';
            document.getElementById('timelineVisualization').style.display = 'block';
            document.getElementById('emailSection').style.display = 'block';
            
            // Scroll
            setTimeout(() => {
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        }
        
        // --- DISPLAY FUNCTIONS ---
        function displayResults(data) {
            const resultsGrid = document.getElementById('resultsSection');
            const isShortage = data.retirementGap > 0;
            
            let resultsHTML = `
                <div class="results-header">
                    <h3>üèñÔ∏è Your Retirement Projection</h3>
                    <p>At age ${data.retirementAge} (${data.yearsToRetirement} years away)</p>
                </div>
                
                <div class="results-grid">
                    <div class="result-card highlight">
                        <h4>üí∞ Portfolio Goal</h4>
                        <div class="amount">$${Math.round(data.totalRetirementFundNeeded).toLocaleString()}</div>
                        <div class="note">Amount needed from investments (after Social Security)</div>
                    </div>
                    
                    <div class="result-card">
                        <h4>üìà Projected Savings</h4>
                        <div class="amount">$${Math.round(data.totalProjectedSavings).toLocaleString()}</div>
                        <div class="note">${(data.expectedReturn * 100).toFixed(1)}% annual return</div>
                    </div>
                    
                    <div class="result-card ${isShortage ? 'warning' : 'good'}">
                        <h4>${isShortage ? '‚ö†Ô∏è Shortage' : 'üéâ Surplus'}</h4>
                        <div class="amount">$${Math.round(Math.abs(data.retirementGap)).toLocaleString()}</div>
                        <div class="note">${isShortage ? 'Gap to reach your goal' : 'Extra cushion available'}</div>
                    </div>
                    
                    <div class="result-card">
                        <h4>${isShortage ? 'üîß Fix Needed' : 'üí™ Great Progress'}</h4>
                        <div class="amount">${isShortage ? '$' + Math.round(data.additionalMonthlyNeeded).toLocaleString() : 'On Track'}</div>
                        <div class="note">${isShortage ? 'Additional monthly savings required' : 'You are fully funded!'}</div>
                    </div>
                </div>
            `;
            
            if (isShortage) {
                resultsHTML += `
                    <div style="background: linear-gradient(135deg, #fff3cd, #ffffff); border: 1px solid var(--warning-color); border-radius: 10px; padding: 1.5rem; margin: 1.5rem 0;">
                        <h4 style="color: var(--warning-color); margin-bottom: 0.5rem;">üìà Action Plan to Close the Gap</h4>
                        <ul style="margin: 0; padding-left: 1.5rem;">
                            <li><strong>Increase monthly contribution</strong> by $<strong>${Math.round(data.additionalMonthlyNeeded).toLocaleString()}</strong> per month</li>
                            <li>Consider employer 401(k) matching - it's free money!</li>
                            <li>Review investment allocation for potential higher returns</li>
                            <li>Delay retirement by 1-2 years to let savings compound longer</li>
                        </ul>
                    </div>
                `;
            }
            resultsGrid.innerHTML = resultsHTML;
        }
        
        function displayStrategyComparison() {
            const strategyResults = document.getElementById('strategyResults');
            const strategies = ['conservative', 'moderate', 'aggressive'];
            
            strategyResults.innerHTML = strategies.map(strategy => {
                const avgReturn = investmentReturns[strategy].avg;
                
                // Recalculate Projection for this specific strategy
                // Using explicit fallbacks (|| 0) to prevent NaN if data is missing
                const startBal = calculationResults.currentSavings || 0;
                const monthlyCont = calculationResults.monthlyContributions || 0;
                const years = calculationResults.yearsToRetirement || 0;
                
                const fvStart = startBal * Math.pow(1 + avgReturn, years);
                
                const mRate = avgReturn / 12;
                let fvCont = 0;
                if (mRate > 0 && years > 0) {
                    fvCont = monthlyCont * ((Math.pow(1 + mRate, years * 12) - 1) / mRate);
                } else {
                    fvCont = monthlyCont * years * 12;
                }
                
                const projected = fvStart + fvCont;
                
                // Calculate Monthly Income (Safe 4% Withdrawal)
                const monthlyIncome = (projected * 0.04) / 12;
                
                // Calculate Goal Coverage (Avoid divide by zero)
                let coverage = 100;
                if (calculationResults.totalRetirementFundNeeded > 0) {
                    coverage = (projected / calculationResults.totalRetirementFundNeeded) * 100;
                }

                return `
                    <div class="comparison-card">
                        <h5>${strategy.charAt(0).toUpperCase() + strategy.slice(1)} Strategy</h5>
                        <div class="comparison-value">${(avgReturn * 100).toFixed(1)}%</div>
                        <div class="note">Expected annual return</div>
                        <div style="font-size: 0.9rem; margin-top: 1rem; color: var(--text-dark); text-align: left; padding-left: 10px;">
                            <div style="margin-bottom: 4px;">
                                <strong>Potential Nest Egg:</strong> $${Math.round(projected).toLocaleString()}
                            </div>
                            <div style="margin-bottom: 4px;">
                                <strong>Monthly Income:</strong> $${Math.round(monthlyIncome).toLocaleString()}
                            </div>
                            <div>
                                <strong>Goal Coverage:</strong> ${Math.round(Math.min(coverage, 999))}%
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function displayTimeline() {
            // Helper for intermediate growth
            function calculateProgress(targetAge) {
                const yearsToTarget = targetAge - calculationResults.currentAge;
                if (yearsToTarget <= 0) return calculationResults.currentSavings;

                const months = yearsToTarget * 12;
                const monthlyRate = calculationResults.expectedReturn / 12;
                
                const fvPrincipal = calculationResults.currentSavings * Math.pow(1 + monthlyRate, months);
                let fvContrib = 0;
                if (monthlyRate > 0) {
                    fvContrib = calculationResults.monthlyContributions * ((Math.pow(1 + monthlyRate, months) - 1) / monthlyRate);
                } else {
                    fvContrib = calculationResults.monthlyContributions * months;
                }
                return fvPrincipal + fvContrib;
            }

            const oneThirdYears = Math.floor(calculationResults.yearsToRetirement / 3);
            const twoThirdsYears = Math.floor(calculationResults.yearsToRetirement * 2 / 3);
            const age1 = calculationResults.currentAge + oneThirdYears;
            const age2 = calculationResults.currentAge + twoThirdsYears;

            const timelineContent = `
                <div class="timeline-title">üóìÔ∏è Your Retirement Savings Journey</div>
                <div class="timeline-grid">
                    <div class="timeline-item">
                        <div class="timeline-year">Age ${calculationResults.currentAge}</div>
                        <div class="timeline-description">Starting Point</div>
                        <div class="timeline-amount">$${Math.round(calculationResults.currentSavings).toLocaleString()}</div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-year">Age ${age1}</div>
                        <div class="timeline-description">${oneThirdYears} Years Progress</div>
                        <div class="timeline-amount">~$${Math.round(calculateProgress(age1)).toLocaleString()}</div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-year">Age ${age2}</div>
                        <div class="timeline-description">${twoThirdsYears} Years Progress</div>
                        <div class="timeline-amount">~$${Math.round(calculateProgress(age2)).toLocaleString()}</div>
                    </div>
                    <div class="timeline-item" style="background: linear-gradient(135deg, #e8f5e8, #ffffff);">
                        <div class="timeline-year">Age ${calculationResults.retirementAge}</div>
                        <div class="timeline-description">üèñÔ∏è Retirement!</div>
                        <div class="timeline-amount">$${Math.round(calculationResults.totalProjectedSavings).toLocaleString()}</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 1rem; background: linear-gradient(135deg, #fff3cd, #ffffff); padding: 1rem; border-radius: 8px;">
                    <strong>Next Steps:</strong> Review your contribution rate, consider catch-up contributions after 50, and maintain your investment allocation.
                </div>
            `;
            document.getElementById('timelineVisualization').innerHTML = timelineContent;
        }
        
        function showStrategy(strategy) {
            document.querySelectorAll('.strategy-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if(event) event.target.classList.add('active');
        }

        // --- EMAIL FUNCTIONALITY ---
        function handleEmailSubmit(event) {
            event.preventDefault(); 
            
            const emailInput = document.getElementById('userEmail');
            const button = document.querySelector('.email-button');
            const formContainer = document.getElementById('emailContent');
            const successMessage = document.getElementById('emailSuccess');
            const originalText = button.innerHTML;
            
            // Only prepare data if calculation has run
            if (!calculationResults || Object.keys(calculationResults).length === 0) {
                alert("Please calculate your retirement plan first!");
                return;
            }

            const formData = {
                email: emailInput.value,
                retirement_age: calculationResults.retirementAge,
                total_needed: Math.round(calculationResults.totalRetirementFundNeeded),
                projected_savings: Math.round(calculationResults.totalProjectedSavings),
                gap: Math.round(calculationResults.retirementGap), 
                monthly_contribution_needed: Math.round(calculationResults.additionalMonthlyNeeded)
            };

            button.innerHTML = 'Sending... ‚è≥';
            button.disabled = true;

            fetch("https://formspree.io/f/xkovojay", {
                method: "POST",
                body: JSON.stringify(formData),
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }
            })
            .then(response => {
                if (response.ok) {
                    formContainer.style.display = 'none';
                    successMessage.style.display = 'block';
                    emailInput.value = '';
                } else {
                    response.json().then(data => {
                        if (data.errors) alert(data.errors.map(e => e.message).join(", "));
                        else alert("Oops! There was a problem submitting your form");
                    });
                }
            })
            .catch(error => {
                alert("Oops! There was a problem submitting your form");
                console.error('Error:', error);
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }

        function resetEmailForm() {
            document.getElementById('emailContent').style.display = 'block';
            document.getElementById('emailSuccess').style.display = 'none';
            document.getElementById('userEmail').value = '';
        }

        // --- INITIALIZATION ---
        document.getElementById('retirementForm').addEventListener('submit', function(e) {
            e.preventDefault();
            document.querySelector('.loading').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('strategyComparison').style.display = 'none';
            document.getElementById('timelineVisualization').style.display = 'none';
            
            setTimeout(() => {
                calculateRetirement();
                document.querySelector('.loading').style.display = 'none';
            }, 1500);
        });

        // Initialize Listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('currentAge').addEventListener('input', updateFutureIncomePreview);
            document.getElementById('retirementAge').addEventListener('input', updateFutureIncomePreview);
        });
    </script>
